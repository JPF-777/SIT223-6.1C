pipeline {
    agent any

    stages {
        stage('Build') {
                steps {
                    echo "Compiling and packaging the code is done by using Maven"
                }
            }
        	stage('Unit & Integration Tests') {
                steps {
                    echo 'Unit tests are done to ensure the code runs as expected and integration tests check to ensure different parts of the application work together as expected. This is done by using TestComplete automation software'
                }
    	    post{
                    failure {
                        script {
                            // Send email with the log as an attachment
                            def log = currentBuild.rawBuild.getLog(100).join('\n')
                            mail to: 'jploveslego101.com',
                                 subject: "Unit & Integration Test Fail: ${currentBuild.fullDisplayName}",
                                 body: "Unit & Integration Test Fail. Check Jenkins for more details.\n\nLog:\n${log}"
                        }
                    }
                    success {
                        mail to: 'jploveslego101.com',
                             subject: "Unit & Integration Test Success: ${currentBuild.fullDisplayName}",
                             body: "Unit & Integration Test Worked."
                    }
                }
            }
    	    stage('Code Analysis') {
                steps {
                    echo 'Analyses code to make sure it meets industry standards. The tool used here is SonarQube'
                }
            }
            stage('Security Scan') {
                steps {
                    echo "Scans code to find any security vulnerabilities and the tool that is used is Snyk Code, for some tests, SonarQube can be used as well"
                }
                post{
                    failure {
                        script {
                            // Send email with the log as an attachment
                            def log = currentBuild.rawBuild.getLog(100).join('\n')
                            mail to: 'jploveslego101.com',
                                 subject: "Secutity Scan Fail: ${currentBuild.fullDisplayName}",
                                 body: "Secutity Scan failed. Check Jenkins for more details.\n\nLog:\n${log}"
                        }
                    }
                    success {
                        mail to: 'jploveslego101.com',
                             subject: "Unit & Integration Test Success: ${currentBuild.fullDisplayName}",
                             body: "Unit & Integration Test Worked."
                    }
                }
            }
    	    stage('Deploy To Staging') {
                steps {
                    echo "Deploys the application to a staging server with it being the AWS EC2 Instance"
                }
            }
    	    stage('Integration Tests On Staging') {
                steps {
                    echo "This makes sure that the application works as expected in a production-like environment. This can be automated on either AWS CodePipeline or AWS CloudFormation"
                }
            }
    	    stage('Deploy To Production') {
                steps {
                    echo "Deploys the application to a production server with it being the AWS EC2 instance"
                }
            }
    }
}
